<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Adesa Design Studio - Billing</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 24px;
		}

		.wrapper {
			width: 100%;
			max-width: 1200px;
		}

		.card {
			background: white;
			border-radius: 12px;
			box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18);
			padding: 28px;
			margin-bottom: 20px;
		}

		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 18px;
			flex-wrap: wrap;
			gap: 12px;
		}

		.title {
			font-size: 24px;
			font-weight: 700;
			color: #2d2d2d;
		}

		.subtitle {
			font-size: 14px;
			color: #666;
			margin-top: 4px;
		}

		.customer-select {
			width: 100%;
			max-width: 400px;
			padding: 12px 14px;
			border: 2px solid #e0e0e0;
			border-radius: 8px;
			font-size: 14px;
			margin-bottom: 20px;
			transition: border-color 0.2s;
		}

		.customer-select:focus {
			outline: none;
			border-color: #667eea;
		}

		.customer-search-wrapper {
			position: relative;
			width: 100%;
			max-width: 400px;
			margin-bottom: 20px;
		}

		.customer-search {
			width: 100%;
			padding: 12px 14px;
			border: 2px solid #e0e0e0;
			border-radius: 8px;
			font-size: 14px;
			transition: border-color 0.2s;
		}

		.customer-search:focus {
			outline: none;
			border-color: #667eea;
		}

		.customer-dropdown {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			max-height: 250px;
			overflow-y: auto;
			background: white;
			border: 2px solid #667eea;
			border-radius: 8px;
			box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
			z-index: 100;
			display: none;
			margin-top: 4px;
		}

		.customer-dropdown.active {
			display: block;
		}

		.customer-option {
			padding: 12px 14px;
			cursor: pointer;
			font-size: 14px;
			border-bottom: 1px solid #f0f0f0;
			transition: background 0.15s ease;
		}

		.customer-option:last-child {
			border-bottom: none;
		}

		.customer-option:hover {
			background: #f9f9fb;
		}

		.customer-option.selected {
			background: #667eea;
			color: white;
		}

		.no-results {
			padding: 12px 14px;
			text-align: center;
			color: #999;
			font-size: 14px;
		}

		.selected-customer {
			padding: 10px 14px;
			background: #f0f4ff;
			border-radius: 6px;
			margin-bottom: 20px;
			font-size: 14px;
			color: #667eea;
			font-weight: 600;
		}

		.invoice-table {
			width: 100%;
			border-collapse: collapse;
			margin-bottom: 16px;
		}

		.invoice-table th,
		.invoice-table td {
			padding: 10px;
			border: 1px solid #e0e0e0;
			font-size: 14px;
		}

		.invoice-table th {
			background: #f9f9fb;
			font-weight: 700;
			color: #444;
			text-align: left;
		}

		.invoice-table input {
			width: 100%;
			padding: 8px;
			border: 1px solid #e0e0e0;
			border-radius: 4px;
			font-size: 14px;
		}

		.invoice-table input:focus {
			outline: none;
			border-color: #667eea;
		}

		.invoice-table .amount-cell {
			background: #f9f9fb;
			font-weight: 600;
			color: #333;
		}

		.photo-cell {
			text-align: center;
		}

		.photo-preview {
			max-width: 60px;
			max-height: 60px;
			object-fit: cover;
			border-radius: 4px;
			border: 1px solid #e0e0e0;
			cursor: pointer;
			position: relative;
		}

		.photo-preview-large {
			position: fixed;
			z-index: 9999;
			max-width: 400px;
			max-height: 400px;
			border: 3px solid #667eea;
			border-radius: 8px;
			box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
			pointer-events: none;
			display: none;
		}

		.photo-btn {
			padding: 4px 8px;
			font-size: 11px;
			border-radius: 4px;
			border: 1px solid #667eea;
			background: white;
			color: #667eea;
			cursor: pointer;
			transition: all 0.2s;
		}

		.photo-btn:hover {
			background: #667eea;
			color: white;
		}

		.remove-photo-btn {
			margin-left: 4px;
			padding: 2px 6px;
			font-size: 10px;
			border: 1px solid #c0392b;
			color: #c0392b;
			background: white;
			border-radius: 4px;
			cursor: pointer;
		}

		.remove-photo-btn:hover {
			background: #c0392b;
			color: white;
		}

		.total-row {
			display: flex;
			justify-content: flex-end;
			align-items: center;
			gap: 20px;
			margin-top: 16px;
			padding: 16px 20px;
			background: #f9f9fb;
			border-radius: 8px;
		}

		.total-label {
			font-size: 18px;
			font-weight: 700;
			color: #2d2d2d;
		}

		.total-amount {
			font-size: 24px;
			font-weight: 700;
			color: #667eea;
		}

		.btn {
			padding: 12px 18px;
			border-radius: 8px;
			border: 2px solid transparent;
			font-size: 14px;
			font-weight: 600;
			cursor: pointer;
			transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease, background 0.15s ease, color 0.15s ease;
		}

		.btn:active {
			transform: translateY(0);
		}

		.btn-primary {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			box-shadow: 0 8px 20px rgba(102, 126, 234, 0.35);
		}

		.btn-primary:hover {
			transform: translateY(-1px);
			box-shadow: 0 10px 24px rgba(118, 75, 162, 0.35);
		}

		.btn-ghost {
			background: white;
			color: #4b4b4b;
			border-color: #e0e0e0;
		}

		.btn-ghost:hover {
			border-color: #667eea;
			color: #333;
			box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
		}

		.btn-small {
			padding: 8px 14px;
			font-size: 13px;
		}

		.actions {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			margin-top: 20px;
		}

		@media (max-width: 768px) {
			.invoice-table {
				font-size: 12px;
			}

			.invoice-table th,
			.invoice-table td {
				padding: 6px;
			}
		}

		@media print {
			.btn, .customer-search-wrapper, #selectedCustomerDisplay, .photo-column {
				display: none !important;
			}
		}
	</style>
</head>
<body>
	<div class="wrapper">
		<div class="card">
			<div class="header">
				<div>
					<div class="title">Create Invoice</div>
					<div class="subtitle">Generate billing for customers</div>
				</div>
				<button class="btn btn-ghost" id="backHome">Back to Home</button>
			</div>

			<div class="customer-search-wrapper">
				<input type="text" class="customer-search" id="customerSearch" placeholder="Search customer by ID, name, or phone...">
				<div class="customer-dropdown" id="customerDropdown"></div>
			</div>
			<div id="selectedCustomerDisplay" style="display: none;"></div>

			<table class="invoice-table" id="invoiceTable">
				<thead>
					<tr>
						<th style="width: 60px;">S.No</th>
						<th>Description</th>
						<th style="width: 100px;">Qty</th>
						<th style="width: 120px;">Value</th>
						<th style="width: 140px;">Amount</th>
						<th class="photo-column" style="width: 100px;">Photo</th>
					</tr>
				</thead>
				<tbody id="invoiceBody">
				</tbody>
			</table>

			<button class="btn btn-ghost btn-small" id="addRowBtn">+ Add Row</button>

			<div class="total-row">
				<span class="total-label">Grand Total:</span>
				<span class="total-amount" id="grandTotal">₹0.00</span>
			</div>

			<div class="actions">
				<button class="btn btn-primary" id="generateInvoice">Generate Invoice</button>
				<button class="btn btn-ghost" id="clearInvoice">Clear All</button>
			</div>
		</div>
	</div>

	<script>
		const storageKey = 'adesaCustomers';
		const getCurrentUser = () => localStorage.getItem('adesaUserEmail');
		let rowCount = 0;
		let selectedCustomer = null;

		const customerSearch = document.getElementById('customerSearch');
		const customerDropdown = document.getElementById('customerDropdown');
		const selectedCustomerDisplay = document.getElementById('selectedCustomerDisplay');
		const invoiceBody = document.getElementById('invoiceBody');
		const addRowBtn = document.getElementById('addRowBtn');
		const grandTotalEl = document.getElementById('grandTotal');
		const backHomeBtn = document.getElementById('backHome');
		const generateBtn = document.getElementById('generateInvoice');
		const clearBtn = document.getElementById('clearInvoice');

		function getCustomers() {
			try {
				const data = localStorage.getItem(storageKey);
				const all = data ? JSON.parse(data) : [];
				const currentUser = getCurrentUser();
				return currentUser ? all.filter(c => c.userEmail === currentUser) : all;
			} catch (e) {
				console.error('Failed to read customers', e);
				return [];
			}
		}

		function filterCustomers(term) {
			const customers = getCustomers();
			if (!term) return customers;

			const normalized = term.trim().toLowerCase();
			return customers.filter(c =>
				[c.customerId, c.fullName, c.phone].some(val =>
					(val || '').toLowerCase().includes(normalized)
				)
			);
		}

		function showDropdown(customers) {
			if (!customers.length) {
				customerDropdown.innerHTML = '<div class="no-results">No customers found</div>';
				customerDropdown.classList.add('active');
				return;
			}

			customerDropdown.innerHTML = customers.map(c => `
				<div class="customer-option" data-customer-id="${c.customerId}">
					<strong>${c.customerId}</strong> - ${c.fullName}<br>
					<small style="color: #666;">${c.phone} • ${c.email}</small>
				</div>
			`).join('');
			customerDropdown.classList.add('active');
		}

		function hideDropdown() {
			customerDropdown.classList.remove('active');
		}

		function selectCustomer(customer) {
			selectedCustomer = customer;
			customerSearch.value = `${customer.customerId} - ${customer.fullName}`;
			selectedCustomerDisplay.innerHTML = `
				<div class="selected-customer">
					✓ Selected: ${customer.fullName} (${customer.customerId}) - ${customer.phone}
				</div>
			`;
			selectedCustomerDisplay.style.display = 'block';
			hideDropdown();
		}

		customerSearch.addEventListener('input', (e) => {
			const term = e.target.value;
			if (term.length === 0) {
				hideDropdown();
				selectedCustomer = null;
				selectedCustomerDisplay.style.display = 'none';
				return;
			}
			const filtered = filterCustomers(term);
			showDropdown(filtered);
		});

		customerSearch.addEventListener('focus', () => {
			if (customerSearch.value && !selectedCustomer) {
				const filtered = filterCustomers(customerSearch.value);
				showDropdown(filtered);
			}
		});

		customerDropdown.addEventListener('click', (e) => {
			const option = e.target.closest('.customer-option');
			if (!option) return;

			const customerId = option.dataset.customerId;
			const customers = getCustomers();
			const customer = customers.find(c => c.customerId === customerId);
			if (customer) {
				selectCustomer(customer);
			}
		});

		document.addEventListener('click', (e) => {
			if (!e.target.closest('.customer-search-wrapper')) {
				hideDropdown();
			}
		});

		function createRow(sNo) {
			const row = document.createElement('tr');
			row.dataset.rowId = rowCount++;
			row.innerHTML = `
				<td style="text-align: center;">${sNo}</td>
				<td><input type="text" class="desc-input" placeholder="Item description"></td>
				<td><input type="number" class="qty-input" min="0" step="1" value="1" placeholder="Qty"></td>
				<td><input type="number" class="value-input" min="0" step="0.01" placeholder="0.00"></td>
				<td class="amount-cell">₹0.00</td>
				<td class="photo-cell photo-column">
					<input type="file" accept="image/*" class="photo-input" style="display: none;">
					<button class="photo-btn add-photo-btn">Add Photo</button>
					<div class="photo-display" style="display: none; margin-top: 4px;">
						<img class="photo-preview" alt="Product photo">
						<button class="remove-photo-btn">×</button>
					</div>
				</td>
			`;

			const qtyInput = row.querySelector('.qty-input');
			const valueInput = row.querySelector('.value-input');
			const amountCell = row.querySelector('.amount-cell');
			const photoInput = row.querySelector('.photo-input');
			const addPhotoBtn = row.querySelector('.add-photo-btn');
			const photoDisplay = row.querySelector('.photo-display');
			const photoPreview = row.querySelector('.photo-preview');
			const removePhotoBtn = row.querySelector('.remove-photo-btn');

			function updateAmount() {
				const qty = parseFloat(qtyInput.value) || 0;
				const value = parseFloat(valueInput.value) || 0;
				const amount = qty * value;
				amountCell.textContent = `₹${amount.toFixed(2)}`;
				updateGrandTotal();
			}

			qtyInput.addEventListener('input', updateAmount);
			valueInput.addEventListener('input', updateAmount);

			// Photo handling
			addPhotoBtn.addEventListener('click', () => photoInput.click());
			
			photoInput.addEventListener('change', (e) => {
				const file = e.target.files[0];
				if (file) {
					const reader = new FileReader();
					reader.onload = (e) => {
						photoPreview.src = e.target.result;
						row.dataset.photo = e.target.result;
						addPhotoBtn.style.display = 'none';
						photoDisplay.style.display = 'block';
					};
					reader.readAsDataURL(file);
				}
			});

			// Create hover preview element
			const hoverPreview = document.createElement('img');
			hoverPreview.className = 'photo-preview-large';
			document.body.appendChild(hoverPreview);

			photoPreview.addEventListener('mouseenter', (e) => {
				if (photoPreview.src) {
					hoverPreview.src = photoPreview.src;
					hoverPreview.style.display = 'block';
				}
			});

			photoPreview.addEventListener('mousemove', (e) => {
				if (hoverPreview.style.display === 'block') {
					const previewWidth = 400;
					const previewHeight = 400;
					const margin = 20;
					
					let left = e.clientX + margin;
					let top = e.clientY + margin;
					
					// Check if preview would go off right edge
					if (left + previewWidth > window.innerWidth) {
						left = e.clientX - previewWidth - margin;
					}
					
					// Check if preview would go off bottom edge
					if (top + previewHeight > window.innerHeight) {
						top = e.clientY - previewHeight - margin;
					}
					
					// Ensure it doesn't go off left edge
					if (left < 0) {
						left = margin;
					}
					
					// Ensure it doesn't go off top edge
					if (top < 0) {
						top = margin;
					}
					
					hoverPreview.style.left = left + 'px';
					hoverPreview.style.top = top + 'px';
				}
			});

			photoPreview.addEventListener('mouseleave', () => {
				hoverPreview.style.display = 'none';
			});

			removePhotoBtn.addEventListener('click', () => {
				hoverPreview.remove();
				photoPreview.src = '';
				photoInput.value = '';
				delete row.dataset.photo;
				addPhotoBtn.style.display = 'inline-block';
				photoDisplay.style.display = 'none';
			});


			return row;
		}

		function addRow() {
			const sNo = invoiceBody.children.length + 1;
			const row = createRow(sNo);
			invoiceBody.appendChild(row);
		}

		function updateGrandTotal() {
			const amounts = Array.from(document.querySelectorAll('.amount-cell')).map(cell => {
				const text = cell.textContent.replace('₹', '').replace(',', '');
				return parseFloat(text) || 0;
			});
			const total = amounts.reduce((sum, amt) => sum + amt, 0);
			grandTotalEl.textContent = `₹${total.toFixed(2)}`;
		}

		function clearInvoice() {
			invoiceBody.innerHTML = '';
			for (let i = 0; i < 5; i++) {
				addRow();
			}
			updateGrandTotal();
		}

		addRowBtn.addEventListener('click', addRow);

		backHomeBtn.addEventListener('click', () => {
			window.location.href = 'homepage.html';
		});

		generateBtn.addEventListener('click', () => {
			if (!selectedCustomer) {
				alert('Please select a customer first.');
				return;
			}

			// Collect invoice data
			const rows = Array.from(document.querySelectorAll('#invoiceBody tr')).map(row => {
				const desc = row.querySelector('.desc-input').value.trim();
				const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
				const value = parseFloat(row.querySelector('.value-input').value) || 0;
				const amount = qty * value;
				return { desc, qty, value, amount };
		}).filter(row => row.desc && (row.qty || row.value)); // Only include rows with description and some data

			if (!rows.length) {
				alert('Please add at least one item to the invoice.');
				return;
			}

			const grandTotal = rows.reduce((sum, row) => sum + row.amount, 0);
		// Store invoice data in localStorage and open invoice generator
		const invoiceData = {				customer: selectedCustomer,
				items: rows,
				grandTotal: grandTotal,
				date: new Date().toISOString()
			};

			localStorage.setItem('pendingInvoice', JSON.stringify(invoiceData));
			window.open('invoicegenrator.html', '_blank');
		});

		clearBtn.addEventListener('click', () => {
			if (confirm('Clear all invoice data?')) {
				selectedCustomer = null;
				customerSearch.value = '';
				selectedCustomerDisplay.style.display = 'none';
				clearInvoice();
			}
		});

		// Check for customer ID in URL and auto-select
		function autoSelectCustomerFromURL() {
			const urlParams = new URLSearchParams(window.location.search);
			const customerId = urlParams.get('customer');
			
			if (customerId) {
				const customers = getCustomers();
				const customer = customers.find(c => c.customerId === customerId);
				if (customer) {
					selectCustomer(customer);
				}
			}
		}

		// Initial setup
		clearInvoice();
		autoSelectCustomerFromURL();
	</script>
</body>
</html>
